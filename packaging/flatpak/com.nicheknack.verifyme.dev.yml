app-id: com.nicheknack.verifyme
runtime: org.gnome.Platform
runtime-version: '48'
sdk: org.gnome.Sdk

command: verify-me

finish-args:
  # Display access
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland

  # Audio access (for TTS playback and recording)
  - --socket=pulseaudio

  # File access for saving audio output
  - --filesystem=home
  - --filesystem=xdg-documents

  # GPU acceleration
  - --device=dri

  # Network access (for downloading models)
  - --share=network

  # Intel GPU workaround - fixes EGL initialization on Alder Lake+ iGPUs
  - --env=WEBKIT_DISABLE_DMABUF_RENDERER=1

modules:
  - name: verify-me
    buildsystem: simple
    build-commands:
      - install -Dm755 verify-me /app/bin/verify-me
      - install -Dm644 icons/icon.png /app/share/icons/hicolor/512x512/apps/com.nicheknack.verifyme.png
      - install -Dm644 icons/128x128.png /app/share/icons/hicolor/128x128/apps/com.nicheknack.verifyme.png 2>/dev/null || true
      - install -Dm644 icons/32x32.png /app/share/icons/hicolor/32x32/apps/com.nicheknack.verifyme.png 2>/dev/null || true
      - install -Dm644 com.nicheknack.verifyme.desktop /app/share/applications/com.nicheknack.verifyme.desktop
      - install -Dm644 com.nicheknack.verifyme.metainfo.xml /app/share/metainfo/com.nicheknack.verifyme.metainfo.xml
      # Bundle engine scripts
      - mkdir -p /app/lib/verify-me/engine/models
      - install -Dm644 engine/*.py /app/lib/verify-me/engine/
      - install -Dm644 engine/models/*.py /app/lib/verify-me/engine/models/
      - install -Dm644 engine/requirements.txt /app/lib/verify-me/engine/
      # Bundle bundled models
      - cp -r models /app/lib/verify-me/models

    sources:
      - type: file
        path: ../../src-tauri/target/release/verify-me
      - type: dir
        path: ../../src-tauri/icons
        dest: icons
      - type: file
        path: com.nicheknack.verifyme.desktop
      - type: file
        path: com.nicheknack.verifyme.metainfo.xml
      - type: dir
        path: ../../engine
        dest: engine
      - type: dir
        path: ../../src-tauri/resources/models
        dest: models
